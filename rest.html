

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="es" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="es" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>6. Implementación de servicios web &mdash; documentación de Desarrollo de Aplicaciones en Internet - </title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/estilos.css" type="text/css" />
    <link rel="index" title="Índice" href="genindex.html" />
    <link rel="search" title="Búsqueda" href="search.html" />
    <link rel="next" title="7. Computación en la nube" href="nube.html" />
    <link rel="prev" title="5. Componentes web" href="componentes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Desarrollo de Aplicaciones en Internet
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contenidos:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="marcado.html">1. Lenguajes de marcado</a></li>
<li class="toctree-l1"><a class="reference internal" href="estilo.html">2. Lenguajes de estilo</a></li>
<li class="toctree-l1"><a class="reference internal" href="cliente.html">3. Programar el lado del cliente</a></li>
<li class="toctree-l1"><a class="reference internal" href="servicios.html">4. Acceso a servicios web de terceros</a></li>
<li class="toctree-l1"><a class="reference internal" href="componentes.html">5. Componentes web</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Implementación de servicios web</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#la-arquitectura-rest">6.1. La arquitectura REST</a></li>
<li class="toctree-l2"><a class="reference internal" href="#envio-de-peticiones-desde-javascript">6.2. Envío de peticiones desde JavaScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="#programacion-de-servicios-web-en-node-js">6.3. Programación de servicios web en Node.js</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#interfaz-comun-de-acceso-a-bases-de-datos">6.3.1. Interfaz común de acceso a bases de datos</a></li>
<li class="toctree-l3"><a class="reference internal" href="#async-await">6.3.2. Async/await</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuracion-del-entorno-de-trabajo-para-ejecutar-localmente-una-aplicacion-web">6.4. Configuración del entorno de trabajo para ejecutar localmente una aplicación web</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#instalacion-rapida-en-linux">6.4.1. Instalación rápida en Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="#instalacion-paso-a-paso">6.4.2. Instalación paso a paso</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prueba-de-la-aplicacion-del-carrito">6.4.3. Prueba de la aplicación del carrito</a></li>
<li class="toctree-l3"><a class="reference internal" href="#depuracion-y-prueba-de-la-aplicacion">6.4.4. Depuración y prueba de la aplicación</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modificacion-de-la-api-rest">6.5. Modificación de la API REST</a></li>
<li class="toctree-l2"><a class="reference internal" href="#despliegue-de-la-aplicacion-web-en-heroku">6.6. Despliegue de la aplicación web en Heroku</a></li>
<li class="toctree-l2"><a class="reference internal" href="#la-politica-del-mismo-origen-y-el-estandar-cors">6.7. La política del mismo origen y el estándar CORS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#peticiones-cors">6.7.1. Peticiones CORS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#autenticacion-de-usuarios">6.8. Autenticación de usuarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="#terminos-de-uso-de-las-apis-web">6.9. Términos de uso de las APIs web</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="nube.html">7. Computación en la  nube</a></li>
<li class="toctree-l1"><a class="reference internal" href="problemas.html">8. Problemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="practicas.html">9. Enunciados de las prácticas</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Desarrollo de Aplicaciones en Internet</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li><span class="section-number">6. </span>Implementación de servicios web</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/rest.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="implementacion-de-servicios-web">
<h1><span class="section-number">6. </span>Implementación de servicios web<a class="headerlink" href="#implementacion-de-servicios-web" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Al estudiar anteriormente los servicios web, nos hemos centrado en el acceso a servicios ofrecidos por terceros; en este tema veremos cómo crear nuestros propios servicios web. Abordaremos el estudio de la arquitectura de servicios conocida como REST (por el inglés, <em>representation state transfer</em>), en la que los agentes proporcionan una interfaz con una semántica uniforme (que, básicamente, se corresponde con las operaciones para crear, recuperar, actualizar y borrar recursos), en lugar de interfaces arbitrarias o específicas de una aplicación concreta.</p>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Las habilidades que deberías adquirir con este tema incluyen las siguientes:</p>
<ul class="simple">
<li><p>Entender los fundamentos de la arquitectura REST.</p></li>
<li><p>Implementar servicios web con Node.js mediante Express.</p></li>
<li><p>Entender la <em>política del mismo origen</em> y cómo superarla con la técnica CORS.</p></li>
<li><p>Desplegar en la nube una aplicación web.</p></li>
</ul>
</div>
<div class="section" id="la-arquitectura-rest">
<span id="label-curl"></span><h2><span class="section-number">6.1. </span>La arquitectura REST<a class="headerlink" href="#la-arquitectura-rest" title="Enlazar permanentemente con este título">¶</a></h2>
<p>REST es una arquitectura para implementar servicios web sobre el protocolo HTTP que es usada actualmente por la gran mayoría de APIs web. Bajo REST los recursos se representan mediante URLs y las acciones a realizar con ellos se indican mediante los correspondientes verbos de HTTP (principalmente, GET, POST, PUT y DELETE).</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>En esta actividad vamos a explorar una API REST <em>de jueguete</em> para gestionar carritos de la compra que se encuentra ya desplegada en la nube. Para acceder a la API vamos a usar <code class="docutils literal notranslate"><span class="pre">curl</span></code>, un programa que permite realizar peticiones HTTP desde la línea de órdenes y observar la respuesta devuelta por el servidor. Ve probando en tu ordenador todos los pasos siguientes.</p>
</div>
<p>En primer lugar, vamos a asignar a una variable de entorno el URL base de la API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">damp</span><span class="o">-</span><span class="n">shore</span><span class="o">-</span><span class="mf">49160.</span><span class="n">herokuapp</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">carrito</span><span class="o">/</span><span class="n">v1</span>
</pre></div>
</div>
<p><em>Nota:</em> la sintaxis que seguiremos aquí para manejar variables de entorno es la usada en sistemas basados en Unix. Para otros sistemas operativos, la sintaxis podría ser ligeramente diferente.</p>
<p>El primer paso con la API del carrito suele ser obtener un identificador de carrito válido, lo que haremos con el verbo POST:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request POST --header &#39;content-type:application/json&#39; -v $endpoint/creacarrito
</pre></div>
</div>
<p>La opción <code class="docutils literal notranslate"><span class="pre">--request</span></code> indica el verbo a usar y la opción <code class="docutils literal notranslate"><span class="pre">--header</span></code> sirve para identificar las cabeceras de la petición; en este caso, usamos la cabecera <code class="docutils literal notranslate"><span class="pre">content-type</span></code> que se usa para indicar al servidor en qué formato (JSON, en este caso) queremos recibir los datos de la respuesta; el servidor podría ignorar nuestra solicitud si no soportara dicho formato, lo que no es el caso. Finalmente, la opción <code class="docutils literal notranslate"><span class="pre">--v</span></code> hace que <code class="docutils literal notranslate"><span class="pre">curl</span></code> muestre información más detallada sobre la petición y la respuesta. La petición anterior nos devolverá en formato JSON el nombre del carrito recién creado en el atributo <code class="docutils literal notranslate"><span class="pre">result.nombre</span></code>. Asigna dicho valor (por ejemplo, <code class="docutils literal notranslate"><span class="pre">fada6</span></code>) a la variable de entorno <code class="docutils literal notranslate"><span class="pre">carrito</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">carrito</span><span class="o">=</span><span class="n">fada6</span>
</pre></div>
</div>
<p>Ten en cuenta que si ningún cliente ha realizado una petición a la API en los últimos minutos, la primera respuesta puede tardar unos segundos en producirse mientras se despierta el servidor. Vamos a añadir ahora un item al carrito. Para ello usamos el verbo POST sobre la ruta <code class="docutils literal notranslate"><span class="pre">$endpoint/$carrito/productos</span></code>; los datos del nuevo item los pasaremos en JSON dentro del cuerpo (<em>payload</em>) del mensaje, al que damos valor con la opción <code class="docutils literal notranslate"><span class="pre">--data</span></code> de <code class="docutils literal notranslate"><span class="pre">curl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request POST --data &#39;{&quot;item&quot;:&quot;queso&quot;,&quot;cantidad&quot;:1}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>El servidor nos devuelve un resultado en JSON con dos atributos, <code class="docutils literal notranslate"><span class="pre">result</span></code> y <code class="docutils literal notranslate"><span class="pre">error</span></code>; el primero contiene información adicional si la petición pudo satisfacerse (el código de estado es 200 en ese caso); el atributo <code class="docutils literal notranslate"><span class="pre">error</span></code> contiene mas información sobre el error en caso de haberse producido (el código de estado es 404 en ese caso); si no procede dar valor a <code class="docutils literal notranslate"><span class="pre">result</span></code> o <code class="docutils literal notranslate"><span class="pre">error</span></code>, estos atributos tomarán el valor <code class="docutils literal notranslate"><span class="pre">null</span></code>. Vamos a añadir otro item al carrito:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request POST --data &#39;{&quot;item&quot;:&quot;leche&quot;,&quot;cantidad&quot;:4}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>Para obtener la composición de un carrito, usaremos el verbo GET:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request GET --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>Obtendremos una respuesta como la siguiente:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;item&quot;</span><span class="p">:</span><span class="s2">&quot;queso&quot;</span><span class="p">,</span><span class="s2">&quot;cantidad&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span>
             <span class="p">{</span><span class="s2">&quot;item&quot;</span><span class="p">:</span><span class="s2">&quot;leche&quot;</span><span class="p">,</span><span class="s2">&quot;cantidad&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">}],</span>
  <span class="s2">&quot;error&quot;</span><span class="p">:</span><span class="n">null</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Para modificar la cantidad de un item ya existente en el carrito, usaremos la acción PUT e indicaremos la nueva cantidad en JSON en el bloque de datos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request PUT --data &#39;{&quot;cantidad&quot;:2}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
</pre></div>
</div>
<p>Comprobamos que el carrito ha sido actualizado con la nueva cantidad:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request GET --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
</pre></div>
</div>
<p>Finalmente, podemos borrar un producto con la acción DELETE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request DELETE --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
curl --request DELETE --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/queso
</pre></div>
</div>
<p>Con la segunda petición, el servidor devolverá un error indicando que el producto no existe.</p>
<p>Si quisiéramos añadir un nuevo item cuyo nombre lleve algún carácter especial (por ejemplo, la vocal con tilde de <em>jamón</em>), lo podemos hacer como en los casos anteriores:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request POST --data &#39;{&quot;item&quot;:&quot;jamón&quot;,&quot;cantidad&quot;:2}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos
</pre></div>
</div>
<p>Pero a la hora de hacer una petición en la que el nombre del item forme parte del URL (y no del bloque de datos), es necesario convertir los caracteres especiales a aquellos que puedan formar parte de un URL a través de lo que se conoce como <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Glossary/percent-encoding">codificación por ciento</a> (<em>percent-encoding</em>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl --request PUT --data &#39;{&quot;cantidad&quot;:5}&#39; --header &#39;content-type:application/json&#39; $endpoint/$carrito/productos/jam%C3%B3n
</pre></div>
</div>
<p>En JavaScript tenemos funciones como <code class="docutils literal notranslate"><span class="pre">decodeURIComponent</span></code>, <code class="docutils literal notranslate"><span class="pre">decodeURI</span></code>, <code class="docutils literal notranslate"><span class="pre">encodeURIComponent</span></code> y <code class="docutils literal notranslate"><span class="pre">encodeURI</span></code> que se encargan del trabajo de conversión. Para codificar un símbolo para el programa <code class="docutils literal notranslate"><span class="pre">curl</span></code> que se ejecuta en la línea de órdenes podemos usar <a class="reference external" href="https://meyerweb.com/eric/tools/dencoder/">herramientas en línea</a>.</p>
</div>
<div class="section" id="envio-de-peticiones-desde-javascript">
<span id="label-cliente-rest"></span><h2><span class="section-number">6.2. </span>Envío de peticiones desde JavaScript<a class="headerlink" href="#envio-de-peticiones-desde-javascript" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Ahora vamos a ver cómo interactuar con la API del carrito desde JavaScript (en concreto, usando la API Fetch que hemos estudiado antes) por medio de una aplicación web de <a class="reference external" href="https://damp-shore-49160.herokuapp.com/carrito.html">gestión de carritos de la compra</a>. Abre las DevTools de Google Chrome y estudia cada una de las peticiones Fetch realizadas por la aplicación. El código de este cliente de la API es el siguiente, que apenas incorpora novedades:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;!doctype html&gt;</span>
<span class="c">&lt;!-- Ejemplos de uso de la API web del carrito con la API Fetch del navegador --&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;es&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;style.css&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Carrito<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Gestión de carritos de la compra<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="c">&lt;!-- Formularios: --&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f0&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Usar un carrito ya existente<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Nombre del carrito:
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;nombre&quot;</span> <span class="na">required</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Usa<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f1&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Crear un nuevo carrito<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Crea<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f2&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Añadir item al carrito<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Nombre del item:
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;item&quot;</span> <span class="na">required</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span> 
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Cantidad:
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;cantidad&quot;</span> <span class="na">required</span> <span class="na">pattern</span><span class="o">=</span><span class="s">&quot;[0-9]+&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span> 
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Añade<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f3&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Actualizar cantidad de un item<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Nombre del item:
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;item&quot;</span> <span class="na">required</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span> 
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Nueva cantidad:
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;cantidad&quot;</span> <span class="na">required</span> <span class="na">pattern</span><span class="o">=</span><span class="s">&quot;[0-9]+&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span> 
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Actualiza<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f4&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Borrar un item del carrito<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Nombre del item:
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;item&quot;</span> <span class="na">required</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Borra<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span> 
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f5&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>Eliminar el carrito actual<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Elimina<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  
  <span class="p">&lt;</span><span class="nt">main</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Nombre del carrito actual: <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;nombre&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Última respuesta del servidor: <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;mensaje&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Contenido del carrito:<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Item<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Cantidad<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tbody</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;listado&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="c1">// Endpoint de la API del carrito:</span>
  <span class="kr">const</span> <span class="nx">base</span><span class="o">=</span><span class="s2">&quot;/carrito/v1&quot;</span><span class="p">;</span>
  
  <span class="kd">var</span> <span class="nx">carrito</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">cabeceras</span><span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">print</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#mensaje&#39;</span><span class="p">);</span>  
    <span class="k">if</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#mensaje&#39;</span><span class="p">);</span>  
    <span class="nx">e</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="sb">`Problema de conexión: </span><span class="si">${</span><span class="nx">s</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
  <span class="p">}</span>

  
  <span class="kd">function</span> <span class="nx">usaCarrito</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span> <span class="c1">// evita la recarga de la página</span>
    <span class="kr">const</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f0 input[name=&#39;nombre&#39;]&quot;</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#nombre&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="o">=</span> <span class="nx">carrito</span><span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">value</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">muestraCarrito</span><span class="p">();</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">creaCarrito</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/creacarrito`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">payload</span><span class="o">=</span> <span class="p">{};</span>
    <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">carrito</span><span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">nombre</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#nombre&quot;</span><span class="p">).</span><span class="nx">textContent</span><span class="o">=</span> <span class="nx">carrito</span><span class="p">;</span>
      <span class="nx">muestraCarrito</span><span class="p">();</span>
      <span class="nx">print</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>


  <span class="kd">function</span> <span class="nx">muestraCarrito</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">carrito</span><span class="si">}</span><span class="sb">/productos`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#listado&#39;</span><span class="p">);</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mf">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">+=</span> <span class="sb">`&lt;tr&gt;</span>
<span class="sb">            &lt;td&gt;</span><span class="si">${</span><span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">item</span><span class="si">}</span><span class="sb">&lt;/td&gt;</span>
<span class="sb">            &lt;td&gt;</span><span class="si">${</span><span class="nx">r</span><span class="p">.</span><span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">cantidad</span><span class="si">}</span><span class="sb">&lt;/td&gt;</span>
<span class="sb">            &lt;/tr&gt;`</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
   
  
  <span class="kd">function</span> <span class="nx">nuevoItem</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">carrito</span><span class="si">}</span><span class="sb">/productos`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">payload</span><span class="o">=</span> <span class="p">{</span>
      <span class="nx">item</span><span class="o">:</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f2 input[name=&#39;item&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
      <span class="nx">cantidad</span><span class="o">:</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f2 input[name=&#39;cantidad&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">print</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f2 input[name=&#39;item&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f2 input[name=&#39;cantidad&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nx">muestraCarrito</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
  
  
  <span class="kd">function</span> <span class="nx">actualizaItem</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">item</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f3 input[name=&#39;item&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">carrito</span><span class="si">}</span><span class="sb">/productos/</span><span class="si">${</span><span class="nx">item</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">payload</span><span class="o">=</span> <span class="p">{</span>
      <span class="nx">cantidad</span><span class="o">:</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f3 input[name=&#39;cantidad&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
    <span class="p">};</span> 
    <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">print</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f3 input[name=&#39;item&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f3 input[name=&#39;cantidad&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nx">muestraCarrito</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
  

  <span class="kd">function</span> <span class="nx">borraItem</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">item</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f4 input[name=&#39;item&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">carrito</span><span class="si">}</span><span class="sb">/productos/</span><span class="si">${</span><span class="nx">item</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">payload</span><span class="o">=</span> <span class="p">{};</span> 
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">print</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f4 input[name=&#39;item&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nx">muestraCarrito</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
  

  <span class="kd">function</span> <span class="nx">eliminaCarrito</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">carrito</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">payload</span><span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span>  <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">print</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> 
      <span class="nx">muestraCarrito</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>


  <span class="c1">// Función de inicialización:</span>
  <span class="kd">function</span> <span class="nx">init</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f0&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">usaCarrito</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span> 
    <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f1&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">creaCarrito</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f2&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">nuevoItem</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f3&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">actualizaItem</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f4&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">borraItem</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f5&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">eliminaCarrito</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>
    
  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span><span class="nx">init</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>El código anterior muestra cómo hacer con <code class="docutils literal notranslate"><span class="pre">fetch</span></code> peticiones con verbos de HTTP diferentes a <code class="docutils literal notranslate"><span class="pre">GET</span></code>, y que incluyen información tanto en las cabeceras como en el bloque de datos (<em>payload</em>).</p>
</div>
<div class="section" id="programacion-de-servicios-web-en-node-js">
<span id="label-servidor-rest"></span><h2><span class="section-number">6.3. </span>Programación de servicios web en Node.js<a class="headerlink" href="#programacion-de-servicios-web-en-node-js" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Los servicios web se pueden programar en prácticamente cualquier lenguaje de programación existente hoy día. Para implementar el servicio web al que hemos accedido desde el cliente mostrado en la actividad anterior hemos usado JavaScript con Node.js y el <em>framework</em> para desarrollo de aplicaciones web <a class="reference external" href="https://expressjs.com/">Express.js</a>. Lo siguiente es el código de la parte del servidor. Más abajo, después del código, se comentan sus principales elementos.</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// carga y ejecuta config.js</span>
<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./config.js&#39;</span><span class="p">);</span>

<span class="c1">// objeto global que referencia a la librería Knexx.js</span>
<span class="kd">var</span> <span class="nx">knex</span><span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="c1">// inicializa Knex.js para usar diferentes bases de datos según el entorno:</span>
<span class="kd">function</span> <span class="nx">conectaBD</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">knex</span><span class="o">===</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CARRITO_ENV</span> <span class="o">===</span> <span class="s1">&#39;gae&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">gae</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Usando Cloud SQL (MySQL) como base de datos en Google App Engine&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CARRITO_ENV</span> <span class="o">===</span> <span class="s1">&#39;heroku&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">heroku</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Usando PostgreSQL como base de datos en Heroku&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">options</span><span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">localbd</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Usando SQLite como base de datos local&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// La siguiente opción muestra la conversión a SQL de cada consulta:</span>
    <span class="c1">// options.debug= true;</span>
    <span class="nx">knex</span><span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;knex&#39;</span><span class="p">)(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// crea las tablas si no existen:</span>
<span class="nx">async</span> <span class="kd">function</span> <span class="nx">creaEsquema</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existeTabla</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">hasTable</span><span class="p">(</span><span class="s1">&#39;carritos&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existeTabla</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">await</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="s1">&#39;carritos&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">tabla</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">tabla</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">&#39;carritoId&#39;</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
        <span class="nx">tabla</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">&#39;nombre&#39;</span><span class="p">,</span> <span class="mf">100</span><span class="p">).</span><span class="nx">notNullable</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Se ha creado la tabla carritos&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">existeTabla</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">hasTable</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existeTabla</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">await</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">&#39;productoId&#39;</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
        <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span> <span class="mf">100</span><span class="p">).</span><span class="nx">notNullable</span><span class="p">();</span>
        <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="mf">100</span><span class="p">).</span><span class="nx">notNullable</span><span class="p">();</span>
        <span class="nx">table</span><span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="s1">&#39;cantidad&#39;</span><span class="p">).</span><span class="nx">unsigned</span><span class="p">().</span><span class="nx">notNullable</span><span class="p">();</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Se ha creado la tabla productos&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Error al crear las tablas: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;error al crear la tabla; contacta con el administrador&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">numeroCarritos</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">n</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;carritos&#39;</span><span class="p">).</span><span class="nx">countDistinct</span><span class="p">(</span><span class="s1">&#39;nombre as n&#39;</span><span class="p">);</span>
  <span class="c1">// the value returned by count in this case is an array of objects like [ { n: 2 } ]</span>
  <span class="k">return</span> <span class="nx">n</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="s1">&#39;n&#39;</span><span class="p">];</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">numeroItems</span><span class="p">(</span><span class="nx">carrito</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">r</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">carrito</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">carrito</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">r</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;carritos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;nombre&#39;</span><span class="p">)</span>
                               <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;nombre&#39;</span><span class="p">,</span><span class="nx">carrito</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">existeItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span><span class="nx">carrito</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">r</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="nx">item</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">carrito</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// convierte el cuerpo del mensaje de la petición en JSON al objeto de JavaScript req.body:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="c1">// middleware para descodificar caracteres UTF-8 en la URL:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nb">decodeURI</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// middleware para las cabeceras de CORS:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE, PUT, GET, POST, OPTIONS&#39;</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content-type&quot;</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>


<span class="c1">// middleware que establece la conexión con la base de datos y crea las </span>
<span class="c1">// tablas si no existen; en una aplicación más compleja se crearía el</span>
<span class="c1">// esquema fuera del código del servidor:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">conectaBD</span><span class="p">();</span>
  <span class="nx">await</span> <span class="nx">creaEsquema</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>


<span class="c1">// crea un carrito:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/creacarrito&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">n</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">numeroCarritos</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="o">&gt;=</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">maxCarritos</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;No caben más carritos; contacta con el administrador&#39;</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nuevo</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mf">7</span><span class="p">);</span>
      <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">nuevo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">c</span><span class="o">=</span> <span class="p">{</span> <span class="nx">nombre</span><span class="o">:</span><span class="nx">nuevo</span> <span class="p">};</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;carritos&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="p">{</span> <span class="nx">nombre</span><span class="o">:</span><span class="nx">nuevo</span> <span class="p">},</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se puede crear el carrito: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo crear el carrito&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// crea un nuevo item:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/:carrito/productos&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">item</span> <span class="o">||</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">cantidad</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;datos mal formados&#39;</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeItem</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`item </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">item</span><span class="si">}</span><span class="sb"> ya existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">n</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">numeroItems</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="o">&gt;=</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">maxProductos</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`No caben más productos en el carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb">`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span> <span class="p">{</span> <span class="nx">carrito</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">,</span><span class="nx">item</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span><span class="nx">cantidad</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">cantidad</span> <span class="p">};</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">insert</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se puede añadir el item: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo añadir el item&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// lista los items de un carrito:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/:carrito/productos&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">i</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">([</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="s1">&#39;cantidad&#39;</span><span class="p">])</span>
                                  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="nx">i</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se puede obtener los productos del carrito: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo obtener los datos del carrito&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// lista los datos de un item:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/:carrito/productos/:item&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeItem</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`item </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">i</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">([</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="s1">&#39;cantidad&#39;</span><span class="p">])</span>
                                  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                                  <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="nx">i</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se pudo obtener el item: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo obtener el item&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// modifica un item:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/:carrito/productos/:item&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">cantidad</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;datos mal formados&#39;</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeItem</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`item </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s1">&#39;cantidad&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">cantidad</span><span class="p">)</span>
                           <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                           <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se pudo obtener el item: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo obtener el item&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// borra un item:</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/:carrito/productos/:item&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeItem</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`item </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">paramsº</span><span class="p">.</span><span class="nx">item</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">).</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">).</span><span class="nx">del</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se pudo obtener el item: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo obtener el item&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// borra un carrito:</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/:carrito&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">existe</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">existeCarrito</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">existe</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`carrito </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="si">}</span><span class="sb"> no existente`</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                           <span class="p">.</span><span class="nx">del</span><span class="p">();</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;carritos&#39;</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;nombre&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                          <span class="p">.</span><span class="nx">del</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se pudo encontrar el carrito: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;no se pudo encontrar el carrito&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="c1">// borra toda la base de datos:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/clear&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                           <span class="p">.</span><span class="nx">del</span><span class="p">();</span>
    <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;nombre&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                         <span class="p">.</span><span class="nx">del</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`No se pudo borrar la base de datos: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">publico</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">);</span>
<span class="c1">// __dirname: directorio del fichero que se está ejecutando</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;API web para gestionar carritos de la compra&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/ayuda&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publico</span><span class="p">,</span> <span class="s1">&#39;index.html&#39;</span><span class="p">)));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">publico</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mf">5000</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Aplicación lanzada en el puerto </span><span class="si">${</span> <span class="nx">PORT</span> <span class="si">}</span><span class="sb">!`</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Express es un <em>módulo</em> de Node.js que permite definir APIs de forma sencilla. La función de Node.js <code class="docutils literal notranslate"><span class="pre">require</span></code> carga un módulo (de forma similar a los <em>import</em> o <em>include</em> de otros lenguajes) y devuelve un objeto que representa los elementos que exporte el módulo.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En este caso, Express exporta una función de inicialización que permite usar el resto de funciones. El código de Express contendrá unas líneas similares a estas:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">createApplication</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">createApplication</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kd">var</span> <span class="nx">app</span><span class="o">=</span> <span class="p">...</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>El código registra o enlaza (llamando a <code class="docutils literal notranslate"><span class="pre">app.use</span></code>) varias <em>funciones de middleware</em>, que serán invocadas incondicionalmente por el <em>framework</em> secuencialmente (en el orden en que aparecen en el código) para cada petición y que se encargan de diversos aspectos:</p>
<ul class="simple">
<li><p>el <em>middleware</em> <code class="docutils literal notranslate"><span class="pre">express.json</span></code>, ya incluido en Express, analiza el JSON de los bloques de datos de las peticiones y crea el objeto de JavaScript correspondientes en <code class="docutils literal notranslate"><span class="pre">req.body</span></code>;</p></li>
<li><p>el resto de funciones de <em>middleware</em> que se registran en este código llamando a <code class="docutils literal notranslate"><span class="pre">app.use</span></code> las definimos nosotros: la primera de ellas descodifica los caracteres que usen la notación <em>por ciento</em> (véase una actividad anterior en este tema); la siguiente añade a la respuesta las cabeceras necesarias para permitir peticiones CORS (como veremos más adelante); la última establece la conexión con el gestor de base de datos (como se comenta más abajo).</p></li>
</ul>
<p>Todas estas funciones de <em>middleware</em> son llamadas por Express con tres parámetros convenientemente inicializados: un objeto que representa la solicitud (llamado <code class="docutils literal notranslate"><span class="pre">req</span></code> en nuestro código), un objeto que representa la respuesta que se devolverá al cliente (<code class="docutils literal notranslate"><span class="pre">res</span></code> en el código) y un objeto que representa la siguiente función de <em>middleware</em> (<code class="docutils literal notranslate"><span class="pre">next</span></code> en el código); cada función de <em>middleware</em> ejecuta un determinado código (que normalmente consultará o modificará los objetos <code class="docutils literal notranslate"><span class="pre">req</span></code> o <code class="docutils literal notranslate"><span class="pre">res</span></code>) y llama a la siguiente función de <em>middleware</em>, excepto cuando se desea acabar inmediatamente el ciclo petición-respuesta y mandar una respuesta al cliente con la función <code class="docutils literal notranslate"><span class="pre">res.send</span></code> (porque la respuesta está lista o porque se detecta algún error como ocurre en la función <code class="docutils literal notranslate"><span class="pre">creaEsquema</span></code>). La siguiente función de <em>middleware</em> recibirá sendas referencias a los mismos objetos de solicitud y respuesta que la actual función puede haber modificado. Aunque es más habitual ir modificando el objeto de la respuesta (con valores que finalmente se devolverán al cliente), en ocasiones puede ser de interés modificar datos de la petición (como en nuestra función de <em>middleware</em> que descodifica la URL).</p>
<p>El código principal de la aplicación está formado por una serie de llamadas a los métodos <code class="docutils literal notranslate"><span class="pre">get</span></code>, <code class="docutils literal notranslate"><span class="pre">post</span></code>, <code class="docutils literal notranslate"><span class="pre">put</span></code> y <code class="docutils literal notranslate"><span class="pre">delete</span></code>, que registran o enlazan funciones de <em>middleware</em> adicionales sobre el objeto de la aplicación; estas funciones se conocen también como funciones <em>manejadoras</em> o de <em>callback</em>, y definen el <em>enrutamiento</em> vinculado con las peticiones en función de su verbo y su URL. Cada petición se realiza con un verbo de HTTP y un URL concreto (a la combinación de ambos se le conoce como <em>endpoint</em>). Estas funciones de <em>middleware</em>, por tanto, no se ejecutan sistemáticamente para cada petición, sino solo cuando la URL y el verbo de la petición casan con el método y ruta indicados.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Express añade automáticamente algunas cabeceras a la respuesta. Por ejemplo, si usamos un objeto de JavaScript como argumento de la llamada a <code class="docutils literal notranslate"><span class="pre">send</span></code>, los datos se convierten a JSON y la cabecera <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> se establece a <code class="docutils literal notranslate"><span class="pre">application/json;</span> <span class="pre">charset=utf-8</span></code>.</p>
</div>
<p>Los diferentes métodos de enrutamiento permiten indicar la ruta del recurso como, por ejemplo, <code class="docutils literal notranslate"><span class="pre">/:carrito/productos</span></code>. Observa cómo una subcadena del URL que comienza por el carácter de dos puntos (por ejemplo, <code class="docutils literal notranslate"><span class="pre">:item</span></code>) no se interpreta literalmente, sino que la subcadena real puesta en el URL de la llamada se usa para dar valor a un atributo del objeto <code class="docutils literal notranslate"><span class="pre">req.params</span></code> ( en ese caso, <code class="docutils literal notranslate"><span class="pre">req.params.item</span></code>). A los atributos de los datos en JSON que aparecen en el bloque de datos (<em>payload</em>) de la petición nos podemos referir mediante el objeto <code class="docutils literal notranslate"><span class="pre">req.body</span></code>, como ya hemos comentado. A los atributos pasados en el propio URL tras el carácter de interrogación se puede acceder mediante el objeto <code class="docutils literal notranslate"><span class="pre">req.query</span></code>.</p>
<p>Si una función de <em>middleware</em> no va a llamar a otra función de <em>middleware</em> posterior (porque devuelve la respuesta al servidor usualmente), no es necesario que declare el tercer parámetro (el que hemos llamado <code class="docutils literal notranslate"><span class="pre">next</span></code> en otros sitios de nuestro código) en la lista de parámetros del manejador.</p>
<div class="admonition attention">
<p class="admonition-title">Atención</p>
<p>Ten en cuenta que el orden en que se registran las funciones de <em>middleware</em> es relevante porque define el orden en que Express las irá llamando. Si el URL de una petición casa con dos rutas registradas (por ejemplo, el URL <code class="docutils literal notranslate"><span class="pre">/listado/clientes</span></code> casa tanto con <code class="docutils literal notranslate"><span class="pre">/:id/clientes</span></code> como con <code class="docutils literal notranslate"><span class="pre">/listado/:id</span></code>), pero en la función de <em>middleware</em> de la primera no se llama a <code class="docutils literal notranslate"><span class="pre">next</span></code>, entonces la segunda función de <em>middleware</em> no será invocada. Express invoca únicamente a la primera función de <em>middleware</em> válida; si se invocan más funciones es porque cada una llama a la siguiente a través del tercer parámetro.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La función de <em>middleware</em> <code class="docutils literal notranslate"><span class="pre">express.static</span></code>, ya definida en el <em>framework</em>, permite indicar un directorio que contiene recursos estáticos (una imagen o una hoja de estilo, por ejemplo) a los que puede acceder el cliente. En nuestro código se llama a <code class="docutils literal notranslate"><span class="pre">app.use</span></code> para vincular dicha función a la ruta raíz y poder servir desde ella los archivos incluidos en la carpeta <code class="docutils literal notranslate"><span class="pre">public</span></code>. El argumento de <code class="docutils literal notranslate"><span class="pre">express.static</span></code> se interpreta, por defecto, como un directorio relativo al directorio actual. Normalmente nos interesará especificar la ruta absoluta, lo que se consigue añadiéndole como prefijo el contenido de la variable global de Node.js <code class="docutils literal notranslate"><span class="pre">__dirname</span></code>, que contiene la ruta absoluta del fichero de JavaScript que se está ejecutando.</p>
</div>
<div class="section" id="interfaz-comun-de-acceso-a-bases-de-datos">
<h3><span class="section-number">6.3.1. </span>Interfaz común de acceso a bases de datos<a class="headerlink" href="#interfaz-comun-de-acceso-a-bases-de-datos" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Como queremos que nuestra aplicación web pueda funcionar en distintas plataformas y estas usan distintos gestores de bases de datos (Heroku permite usar PostgreSQL, Google Cloud Platform permite usar MySQL, y en modo local vamos a usar una base de datos <em>ligera</em> mediante SQLite para hacer pruebas), nos interesa no tener que escribir código diferente para cada sistema de base de datos. Node.js no tiene un equivalente exacto a, por ejemplo, la tecnología JDBC de Java, pero el paquete <a class="reference external" href="http://knexjs.org/">Knex.js</a> (pronunciado como <em>konnex</em>) se acerca bastante al permitirnos interactuar con diferentes gestores de bases de datos con una interfaz única. Con Knex.js usaremos funciones para construir las consultas a la base de datos que serán transformadas internamente en instrucciones SQL; las peticiones a la base de datos son asíncronas y se gestionan mediante promesas o mediante <em>callbacks</em>. Las funciones que a este respecto se usan en el código son bastante autoexplicativas y es muy sencillo deducir cuál es su transformación en SQL. Por ejemplo, las líneas de código:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;productos&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">([</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="s1">&#39;cantidad&#39;</span><span class="p">])</span>
                              <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;carrito&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">carrito</span><span class="p">)</span>
                              <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">,</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">item</span><span class="p">);</span>
</pre></div>
</div>
<p>generan una petición SQL como la siguiente:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>select `item`, `cantidad` from `productos` where `carrito` = ? and `item` = ?
</pre></div>
</div>
<p>Knex.js realiza las consultas a la base de datos de forma asíncrona de manera que nuestro código pueda seguir ejecutándose mientras el gestor de bases de datos devuelve un resultado. Por ello, la mayoría de métodos que invoquemos (como <code class="docutils literal notranslate"><span class="pre">select</span></code> en el fragmento anterior) devolverán una promesa; pero si es así, ¿dónde está la llamada al método <code class="docutils literal notranslate"><span class="pre">then</span></code> correspondiente?
El pequeño fragmento de código anterior y el código completo del servidor de esta actividad usan una palabra reservada de JavaScript (<code class="docutils literal notranslate"><span class="pre">await</span></code>) que no conocíamos. Vamos a ver a continuación, como por medio de ella podemos simplificar la escritura de código que usa promesas y se hace innecesario el uso de los métodos <code class="docutils literal notranslate"><span class="pre">then</span></code> y <code class="docutils literal notranslate"><span class="pre">catch</span></code>.</p>
</div>
<div class="section" id="async-await">
<h3><span class="section-number">6.3.2. </span>Async/await<a class="headerlink" href="#async-await" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Las promesas de la API Fetch son, como hemos visto, una forma muy conveniente de gestionar peticiones a un servidor, pero cuando la llamada a un servicio web depende del resultado de una llamada anterior a otro servicio web y este anidamiento se va haciendo más y más complejo, la escritura del código puede ser dificultosa y afectar negativamente a su legibilidad. Para simplificarlo, entre otros motivos, se añadieron a JavaScript los modificadores <code class="docutils literal notranslate"><span class="pre">async</span></code> y <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p>
<p>Una función anotada con <code class="docutils literal notranslate"><span class="pre">async</span></code> siempre devuelve una promesa. Si la función ya devuelve una promesa, el intérprete no tiene más que hacer. Si devuelve otro tipo de valor, el intérprete crea una promesa que se resuelve (se cumple) directamente con el valor devuelto. Si la función asíncrona lanza una excepción, esta se envuelve en una promesa incumplida.</p>
<p>Observa cómo la siguiente función devuelve una promesa:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mf">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">foo</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span> <span class="c1">// imprime 1</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Asegúrate de que entiendes por qué en el código anterior <code class="docutils literal notranslate"><span class="pre">foo().then(console.log)</span></code> es una versión más corta que la equivalente <code class="docutils literal notranslate"><span class="pre">foo().then(x</span> <span class="pre">=&gt;</span> <span class="pre">console.log(x))</span></code>.</p>
</div>
<p>Dentro de una función asíncrona pueden aparecer cualquier número de expresiones <code class="docutils literal notranslate"><span class="pre">await</span></code> (estas expresiones, de hecho, solo pueden aparecer dentro de funciones <code class="docutils literal notranslate"><span class="pre">async</span></code>). Una expresión <code class="docutils literal notranslate"><span class="pre">await</span></code> va seguida de un objeto de tipo promesa; al llegar a ella el intérprete de JavaScript pausa la ejecución de la función asíncrona y espera a que la promesa se resuelva para continuar con la ejecución. Mientras tanto, otras funciones que estén esperando en la cola de <em>callbacks</em> serán atendidas como procede. El uso de <code class="docutils literal notranslate"><span class="pre">async</span></code>, por tanto, constituye una sintaxis alternativa, más elegante y legible, al uso de <code class="docutils literal notranslate"><span class="pre">promesa.then</span></code>.</p>
<p>El código que vimos que accedía con Fetch a la API de películas del Studio Ghibli quedaría de la siguiente manera con  <code class="docutils literal notranslate"><span class="pre">async</span></code> y <code class="docutils literal notranslate"><span class="pre">await</span></code>:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">ghibli</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">s</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">response</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://ghibliapi.herokuapp.com/films/&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">responseAsObject</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mf">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">responseAsObject</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span><span class="o">+=</span> <span class="nx">responseAsObject</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="o">+</span><span class="s2">&quot;; &quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Ha habido un problema: &#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">print</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">resultado</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#results&quot;</span><span class="p">);</span>
  <span class="nx">resultado</span><span class="p">.</span><span class="nx">textContent</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">ghibli</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">print</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
<p>Si una promesa se cumple, entonces <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">promesa</span></code> devuelve el resultado (que aquí asignamos a las variables <code class="docutils literal notranslate"><span class="pre">response</span></code> y <code class="docutils literal notranslate"><span class="pre">responseAsObject</span></code>). Si la promesa no se cumple, se lanzará automáticamente una excepción en ese punto que podremos capturar dentro de un bloque <code class="docutils literal notranslate"><span class="pre">try..catch</span></code>; en el ejemplo anterior hay tres posibles motivos por los que se puede terminar ejecutando el código del bloque <code class="docutils literal notranslate"><span class="pre">catch</span></code>: la excepción lanzada explícitamente con <code class="docutils literal notranslate"><span class="pre">throw</span></code> y los incumplimientos de las promesas de <code class="docutils literal notranslate"><span class="pre">fetch</span></code> (cuando no se puede conectar con el servidor) o de <code class="docutils literal notranslate"><span class="pre">json</span></code> (cuando el bloque de datos de la respuesta del servidor no puede convertirse en un objeto de JavaScript).</p>
<p>Volviendo al código que usa Knex.js, las siguientes dos líneas de código son equivalentes, pero la segunda sintaxis nos permitirá escribir código más limpio cuando tengamos consultas encadenadas a la base de datos (como ocurre en muchos puntos de la API del carrito):</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">knex</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">row</span><span class="p">);});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">await</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>Tras analizar y entender el código anterior, tanto el del lado del cliente como el del servidor, estudia el vídeo en el que se realiza una traza de su ejecución: <a class="reference external" href="https://drive.google.com/file/d/1pT44L_aoi9rOLPBK5ItJweSOPO4JcFYP/view?usp=sharing">parte 1-1</a>.</p>
</div>
</div>
</div>
<div class="section" id="configuracion-del-entorno-de-trabajo-para-ejecutar-localmente-una-aplicacion-web">
<span id="label-local"></span><h2><span class="section-number">6.4. </span>Configuración del entorno de trabajo para ejecutar localmente una aplicación web<a class="headerlink" href="#configuracion-del-entorno-de-trabajo-para-ejecutar-localmente-una-aplicacion-web" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta actividad se explica cómo configurar el entorno de trabajo para poder lanzar aplicaciones web escritas en Node.js que usan una base de datos SQLite3. Se ofrecen dos vías: una rápida que permite instalar todos los programas necesarios con un <em>script</em> para Linux y otra que requiere ir instalándolos uno a uno.</p>
<div class="section" id="instalacion-rapida-en-linux">
<h3><span class="section-number">6.4.1. </span>Instalación rápida en Linux<a class="headerlink" href="#instalacion-rapida-en-linux" title="Enlazar permanentemente con este título">¶</a></h3>
<p>El sistema operativo <em>oficial</em> en esta asignatura es Linux. Puedes utilizar otros sistemas operativos para desarrollar, pero tendrás que solucionar tú mismo los problemas relacionados con la configuración del entorno de trabajo que te encuentres. Las instrucciones que siguen son para el sistema operativo Linux, pero es muy probable que las puedas ignorar si usas el fichero <a class="reference external" href="https://www.dlsi.ua.es/~japerez/cursos/dai/dai-bundle-dev-20211005.tar.gz">dai-bundle-dev</a> para instalar los programas necesarios. Para ello, descarga el fichero, descomprímelo y ejecuta el script <code class="docutils literal notranslate"><span class="pre">install.sh</span></code>.</p>
<p>Puedes editar el fichero para indicar qué programas quieres instalar. El script solo instala Node.js por defecto. Comprueba si tienes instalado <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> en tu ordenador para saber si lo necesitas y pon a <code class="docutils literal notranslate"><span class="pre">true</span></code> la variable correspondiente en caso negativo. El script también permite instalar el SDK de Google Cloud Platform, que usaremos más adelante.</p>
<p>El script, además, funciona sin problemas en el sistema Linux instalado en los ordenadores de los laboratorios, donde SQLite3 ya está instalado.</p>
<p>Si todo ha ido bien, puedes saltar el siguiente apartado y pasar a ejecutar directamente la aplicación del carrito como se comenta en «<a class="reference internal" href="#label-prueba-carrito"><span class="std std-ref">Prueba de la aplicación del carrito</span></a>».</p>
</div>
<div class="section" id="instalacion-paso-a-paso">
<h3><span class="section-number">6.4.2. </span>Instalación paso a paso<a class="headerlink" href="#instalacion-paso-a-paso" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Comienza instalando <a class="reference external" href="https://nodejs.org/">Node.js</a>, el entorno que te permitirá ejecutar programas en JavaScript fuera del navegador. Las instrucciones para cada sistema operativo son diferentes. Para el caso de Linux, la instalación se puede realizar fácilmente sin necesidad de tener privilegios de administrador descargando uno de los <a class="reference external" href="https://nodejs.org/en/download/releases/">paquetes disponibles</a> en la web de Node.js.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si tu distribución de Linux tiene ya instalada una versión muy antigua de Node.js es recomendable que la quites antes de tu sistema con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">nodejs</span>
</pre></div>
</div>
</div>
<p>Este curso vamos a usar la versión 14 de Node.js. Descárgala con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">nodejs</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">v14</span><span class="o">.</span><span class="mf">18.0</span><span class="o">/</span><span class="n">node</span><span class="o">-</span><span class="n">v14</span><span class="o">.</span><span class="mf">18.0</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>Descomprime el fichero anterior en tu directorio raíz:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>tar xzf node-v14.18.0-linux-x64.tar.gz -C $HOME
</pre></div>
</div>
<p>Añade el directorio <code class="docutils literal notranslate"><span class="pre">bin</span></code> a la variable <code class="docutils literal notranslate"><span class="pre">PATH</span></code> del sistema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo &#39;export PATH=$HOME/node-v14.18.0-linux-x64/bin:$PATH&#39; &gt;&gt; $HOME/.bashrc
</pre></div>
</div>
<p>Abre un nuevo terminal para que el nuevo valor de la variable de entorno <code class="docutils literal notranslate"><span class="pre">PATH</span></code> se aplique. Ahora deberías poder ver la versión de Node.js instalada con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="o">-</span><span class="n">v</span>
</pre></div>
</div>
<p>La aplicación del carrito usa en modo local el gestor de base de datos <em>ligero</em> <a class="reference external" href="https://www.sqlite.org/index.html">SQLite3</a> para no depender de gestores más complejos. Cuando la aplicación se despliegue en la nube (un poco más adelante lo haremos en Heroku y, posteriormente, en Google Cloud Platform), usará otros gestores de bases de datos, lo que explica las diferentes opciones dentro de la función <code class="docutils literal notranslate"><span class="pre">conectaBD</span></code>. Comprueba si ya tienes SQLite instalado ejecutando <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> desde la línea de órdenes. Si no lo tienes, para el caso de Linux puedes descargar este fichero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="mi">2019</span><span class="o">/</span><span class="n">sqlite</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">3300100.</span><span class="n">zip</span>
</pre></div>
</div>
<p>Descomprime el fichero anterior en tu directorio raíz y añade el nuevo directorio a la variable <code class="docutils literal notranslate"><span class="pre">PATH</span></code> del sistema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>unzip -q sqlite-tools-linux-x86-3300100.zip -d $HOME
echo &#39;export PATH=$HOME/sqlite-tools-linux-x86-3300100:$PATH&#39; &gt;&gt; $HOME/.bashrc
</pre></div>
</div>
<p>Abre un nuevo terminal para que el nuevo valor de la variable de entorno <code class="docutils literal notranslate"><span class="pre">PATH</span></code> se aplique.</p>
<p>Los binarios de SQLite están compilados para 32 bits, por lo que es posible que necesites instalar algunas librerías adicionales de 32 bits, ya que tu sistema es proablemente de 64 bits; la siguiente orden es para Ubuntu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libc6</span><span class="o">-</span><span class="n">i386</span> <span class="n">lib32z1</span>
</pre></div>
</div>
<p>Ahora deberías poder ver la versión de SQLite3 instalada con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlite3</span> <span class="o">-</span><span class="n">version</span>
</pre></div>
</div>
</div>
<div class="section" id="prueba-de-la-aplicacion-del-carrito">
<span id="label-prueba-carrito"></span><h3><span class="section-number">6.4.3. </span>Prueba de la aplicación del carrito<a class="headerlink" href="#prueba-de-la-aplicacion-del-carrito" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A continuación, descarga el código del cliente y del servidor de la aplicación del carrito; clona para ello el <a class="reference external" href="https://github.com/jaspock/dai2122">repositorio de la asignatura</a> haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jaspock</span><span class="o">/</span><span class="n">dai2122</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>Entra en el directorio <code class="docutils literal notranslate"><span class="pre">code/carrito</span></code> y ejecuta:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span>
<span class="n">node</span> <span class="n">app</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
<p>La primera línea instala en la carpeta <code class="docutils literal notranslate"><span class="pre">node_modules</span></code> todas las dependencias indicadas en el fichero <code class="docutils literal notranslate"><span class="pre">package.json</span></code>. La segunda línea lanza el motor de JavaScript sobre el fichero indicado. Como este fichero contiene una aplicación web escrita con el framework Express, este la ejecuta sobre un puerto local, por lo que podremos acceder a ella abriendo en el navegador una dirección como <code class="docutils literal notranslate"><span class="pre">localhost:5000</span></code> o similar.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si quisieras usar un nuevo paquete en tu aplicación (lo que probablemente no ocurrirá en esta asignatura), deberías ejecutar:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span> <span class="n">paquete</span>
</pre></div>
</div>
<p>donde <code class="docutils literal notranslate"><span class="pre">paquete</span></code> es el nombre del nuevo módulo; esta orden instala el nuevo módulo en la carpeta <code class="docutils literal notranslate"><span class="pre">node_modules</span></code> y, además, añade la línea adecuada al fichero <code class="docutils literal notranslate"><span class="pre">package.json</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Observa la sección <code class="docutils literal notranslate"><span class="pre">scripts</span></code> del fichero <code class="docutils literal notranslate"><span class="pre">package.json</span></code>. Allí puedes definir diversas maneras de arrancar tu aplicación con diferentes configuraciones. En este caso, solo hay una entrada <code class="docutils literal notranslate"><span class="pre">start</span></code> que te permitiría lanzar también tu aplicación haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">start</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="depuracion-y-prueba-de-la-aplicacion">
<h3><span class="section-number">6.4.4. </span>Depuración y prueba de la aplicación<a class="headerlink" href="#depuracion-y-prueba-de-la-aplicacion" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Si deseas depurar el código del servidor en modo local puedes usar el editor de texto <a class="reference external" href="https://code.visualstudio.com/">Visual Studio Code</a>. Abre con él el fichero <code class="docutils literal notranslate"><span class="pre">app.js</span></code> y selecciona <span class="guilabel">Run / Start debugging</span>. Puedes definir puntos de ruptura haciendo click en el borde de la línea de código oportuna.</p>
<blockquote>
<div></div></blockquote>
<p>Suele ser útil también poder ver un informe detallado de qué rutas puede procesar Express y qué hace con cada petición que llega; para ello puedes lanzar el servidor en modo depuración en Linux con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DEBUG</span><span class="o">=</span><span class="n">express</span><span class="p">:</span><span class="o">*</span> <span class="n">node</span> <span class="n">app</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
<p>Para depurar la aplicación cuando esta se encuentra desplegada en la nube, se necesitan algunas instrucciones adicionales. En el caso de nuestra aplicación, como el código que se ejecuta en <code class="docutils literal notranslate"><span class="pre">localhost</span></code> o en la nube es prácticamente el mismo, si la aplicación funciona en local, apenas deberían aparecer problemas en la nube.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Ten en cuenta que el código de JavaScript que se ejecuta en el navegador se seguirá depurando desde las Chrome DevTools. Durante la depuración de la aplicación irás alternando entre el navegador y Visual Studio Code según se esté ejecutando el código del lado del cliente o del servidor, respectivamente.</p>
</div>
<p>Al ejecutar la aplicación en modo local se usa el gestor de base de datos SQLite, que almacena la base de datos en un fichero indicado como opción de inicialización a Knex.js (en nuestra aplicación el fichero se indica en <code class="docutils literal notranslate"><span class="pre">config.js</span></code>). Si quieres borrar toda la base de datos para empezar de cero, basta con que borres ese fichero, que será creado de nuevo la siguiente vez que Knex.js quiera acceder a él.</p>
<p>Si quieres, realizar consultas a la base de datos local desde un cliente de SQL puedes hacer desde la línea de órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlite3</span> <span class="o">&lt;</span><span class="n">ficheroBD</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>donde has de indicar como argumento el nombre del fichero de la base de datos (si no has editado los ficheros de configuración del carrito se llamará <code class="docutils literal notranslate"><span class="pre">midb.sqlite</span></code>). Desde dentro del cliente puedes ejecutar instrucciones como:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">tables</span>
</pre></div>
</div>
<p>para ver las tablas de la base de datos o:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">productos</span><span class="p">;</span>
</pre></div>
</div>
<p>para consultarlas.</p>
<p>Por último, si añades a la inicialización de Knex.js la propiedad <code class="docutils literal notranslate"><span class="pre">debug:true</span></code> se mostrará el equivalente en SQL de cada operación realizada con la librería.</p>
</div>
</div>
<div class="section" id="modificacion-de-la-api-rest">
<span id="label-api-cambio"></span><h2><span class="section-number">6.5. </span>Modificación de la API REST<a class="headerlink" href="#modificacion-de-la-api-rest" title="Enlazar permanentemente con este título">¶</a></h2>
<p>En esta actividad, vas a realizar una pequeña modificación a la API del carrito y a la aplicación web que la utiliza. El desarrollo lo realizarás en tu máquina y, cuando hayas comprobado que todo funciona correctamente, lo subirás en la siguiente actividad a un servidor de aplicaciones en la nube.</p>
<div class="admonition hint">
<p class="admonition-title">Consejo</p>
<p>Si vas a desarrollar frecuentemente con Node.js, te vendrá bien utilizar la herramienta <a class="reference external" href="https://www.npmjs.com/package/nodemon">nodemon</a>, que evita que tengas que matar y volver a lanzar el servidor local cada vez que hagas un cambio en la aplicación.</p>
<p>Para utilizar <code class="docutils literal notranslate"><span class="pre">nodemon</span></code> mientras depuras desde Visual Studio Code, has de instalar globalmente el programa con <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">-g</span> <span class="pre">nodemon</span></code>. A continuación, abre desde el editor de texto el directorio donde se almacena la aplicación web y abre el código del servidor. En la vista de <span class="guilabel">Run</span> de la izquierda, pincha en <span class="guilabel">create a launch.json file</span> y selecciona el entorno Node.js. En el fichero <code class="docutils literal notranslate"><span class="pre">launch.json</span></code> que se te abre, pulsa el botón <span class="guilabel">Add configuration…</span> y selecciona <span class="guilabel">Node.js: Nodemon setup</span> y graba el fichero. Finalmente, en el menú desplegable de la parte superior de la vista <span class="guilabel">Run</span> escoge <span class="guilabel">nodemon</span> y lanza la aplicación en modo depuración desde el menú <span class="guilabel">Run</span>.</p>
</div>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>Modifica la parte del cliente y del servidor de la aplicación del carrito para que junto con la cantidad se pueda añadir el precio unitario de cada item. Necesitarás instalar en tu sistema Node.js y el gestor de base de datos SQLite3; sigue para ello los pasos detallados en la actividad «<a class="reference internal" href="#label-local"><span class="std std-ref">Configuración del entorno de trabajo para ejecutar localmente una aplicación web</span></a>». Salvo que uses <code class="docutils literal notranslate"><span class="pre">nodemon</span></code>, como se ha comentado antes, tendrás que matar y relanzar el servidor para que se apliquen los cambios. Como siempre, tendrás que recargar la página en el navegador siempre que realices algún cambio en el código del cliente.</p>
</div>
</div>
<div class="section" id="despliegue-de-la-aplicacion-web-en-heroku">
<span id="label-heroku"></span><h2><span class="section-number">6.6. </span>Despliegue de la aplicación web en Heroku<a class="headerlink" href="#despliegue-de-la-aplicacion-web-en-heroku" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Cuando tengas la aplicación lista en modo local, puedes desplegarla en la plataforma en la nube de <a class="reference external" href="https://www.heroku.com/">Heroku</a> como sigue.
Copia para empezar la carpeta <code class="docutils literal notranslate"><span class="pre">dai2122/code/carrito</span></code> en otra ubicación de tu sistema. Al copiar la carpeta a una ubicación diferente haces que su contenido no esté ligado al repositorio de Github, ya que para desplegar la aplicación en Heroku necesitas vincularla a otro repositorio.</p>
<p>Instala el cliente de línea de órdenes (CLI, por <em>command-line interface</em>) de Heroku con las <a class="reference external" href="https://devcenter.heroku.com/articles/heroku-cli#download-and-install">instrucciones de esta página</a>. En el caso de Linux basta con descargar el fichero con los binarios, descomprimirlo y añadir la carpeta <code class="docutils literal notranslate"><span class="pre">bin</span></code> a la variable <code class="docutils literal notranslate"><span class="pre">PATH</span></code> del sistema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -O https://cli-assets.heroku.com/heroku-linux-x64.tar.gz
tar xzf heroku-linux-x64.tar.gz -C $HOME
echo &#39;export PATH=$HOME/heroku/bin:$PATH&#39; &gt;&gt; $HOME/.bashrc
</pre></div>
</div>
<p>Si tienes permisos de administrador puedes instalar de forma alternativa el cliente de línea de órdenes de Heroku en Ubuntu con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">curl</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">cli</span><span class="o">-</span><span class="n">assets</span><span class="o">.</span><span class="n">heroku</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">install</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">sh</span>
</pre></div>
</div>
<p>o alternativamente:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">snap</span> <span class="n">install</span> <span class="o">--</span><span class="n">classic</span> <span class="n">heroku</span>
</pre></div>
</div>
<p>Continúa ahora configurando tu proyecto haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">init</span>
<span class="n">git</span> <span class="n">add</span> <span class="o">.</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;cambios&quot;</span>
</pre></div>
</div>
<p>Con lo anterior, se crea un repositorio con los ficheros del proyecto, que podrás subir (<em>push</em>) a Heroku. Crea una cuenta en la web de Heroku e identifícate en el cliente de línea de órdenes ejecutando:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">login</span>
</pre></div>
</div>
<p>Crea un proyecto en la nube haciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">create</span> <span class="o">--</span><span class="n">region</span> <span class="n">eu</span>
</pre></div>
</div>
<p>Desde este momento ya podrás <a class="reference external" href="https://devcenter.heroku.com/articles/git">desplegar la aplicación</a> con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Heroku puede, en principio, leer del fichero <code class="docutils literal notranslate"><span class="pre">app.json</span></code> datos como el gestor de base de datos a utilizar o el valor de ciertas variables de entorno que estarán definidas en el entorno de producción, pero en el momento de escribir esto no funciona. Por ello, has de configurar estos aspectos de tu aplicación ejecutando lo siguiente desde la línea de órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">addons</span><span class="p">:</span><span class="n">create</span> <span class="n">heroku</span><span class="o">-</span><span class="n">postgresql</span><span class="p">:</span><span class="n">hobby</span><span class="o">-</span><span class="n">dev</span>
<span class="n">heroku</span> <span class="n">config</span><span class="p">:</span><span class="nb">set</span> <span class="n">CARRITO_ENV</span><span class="o">=</span><span class="n">heroku</span>
</pre></div>
</div>
<p>Si ejecutas <code class="docutils literal notranslate"><span class="pre">heroku</span> <span class="pre">config</span></code> podrás ver que ahora hay dos variables de entorno: <code class="docutils literal notranslate"><span class="pre">CARRITO_ENV</span></code> y <code class="docutils literal notranslate"><span class="pre">DATABASE_URL</span></code>.</p>
</div>
<p>Finalmente, abre la aplicación en el navegador con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="nb">open</span>
</pre></div>
</div>
<p>Puedes estudiar los mensajes de actividad emitidos a la consola por tu aplicación implementada en Heroku con:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">logs</span>
</pre></div>
</div>
<p>Para verlos conforme se van produciendo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">logs</span> <span class="o">--</span><span class="n">tail</span>
</pre></div>
</div>
<p>Si haces cambios en la aplicación, basta con repetir estos pasos para actualizar la aplicación en Heroku:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">add</span> <span class="o">.</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;cambios&quot;</span>
<span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</pre></div>
</div>
<p>Para volver a obtener el código de una aplicación si lo hemos perdido, basta con hacer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">git</span><span class="p">:</span><span class="n">clone</span> <span class="o">-</span><span class="n">a</span> <span class="n">nombre</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="mi">12345</span>
</pre></div>
</div>
<p>Finalmente, puedes usar el <a class="reference external" href="https://dashboard.heroku.com/">panel de control</a> de tu aplicación en Heroku para acceder a ciertas opciones adicionales de configuración. Por otro lado, en el panel de control de la <a class="reference external" href="https://data.heroku.com/">base de datos</a> PostgreSQL puedes visitar la sección <span class="guilabel">Dataclips</span> para poder ver las tablas de tu base de datos y lanzar consultas SQL sobre ellas.</p>
</div>
<div class="section" id="la-politica-del-mismo-origen-y-el-estandar-cors">
<span id="label-cors"></span><h2><span class="section-number">6.7. </span>La política del mismo origen y el estándar CORS<a class="headerlink" href="#la-politica-del-mismo-origen-y-el-estandar-cors" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Todos los navegadores implementan una restricción conocida como <em>política del mismo origen</em> (en inglés, <em>same-origin policy</em>), un concepto de seguridad existente desde la época de Netscape 2.0 para peticiones basadas en XHR o en la API Fetch. Esta política impide por defecto que desde un script bajado de un determinado servidor se realicen peticiones a servicios web disponibles en un servidor con un dominio diferente. Permitir este tipo de accesos abre la puerta a toda una serie de potenciales problemas: por ejemplo, <em>MaliciousSite.com</em> usa los servicios web de la web de <em>MyBank.com</em> (en la que el usuario tiene sesión abierta en otra pestaña del navegador) para obtener información confidencial; los servicios web de <em>MyBank.com</em> devuelven la información solicitada porque el usuario está autenticado y la <em>cookie</em> de autenticación es enviada por el navegador junto con la petición; el script con origen <em>MaliciousSite.com</em> puede ahora compartir esta información con otros servidores.</p>
<p>Si la política del mismo origen no pudiera evitarse, muchas aplicaciones web que usan servicios web <em>de terceros</em> desde el cliente no podrían existir o deberían implementar un <em>proxy</em> a dichos servicios web en su propio servidor (es decir, el cliente realizaría una petición a su servidor y desde este, donde ya no existe la restricción del mismo origen al no haber navegador ni riesgos, se realizaría la petición al servidor de terceros). Por ello, los navegadores permiten bajo determinadas condiciones que estos accesos puedan realizarse. En particular, la técnica estándar CORS (<em>cross-origin resource sharing</em>) utiliza la cabecera <code class="docutils literal notranslate"><span class="pre">Origin</span></code> (que es añadida por el navegador y no puede modificarse desde JavaScript) en la petición para informar al servidor del origen del código que está haciendo la solicitud. El servidor puede autorizar o denegar entonces el acceso añadiendo a la respuesta un valor adecuado en la cabecera <code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Origin</span></code>; si el valor de esta última cabecera en la respuesta coincide con el valor de <code class="docutils literal notranslate"><span class="pre">Origin</span></code> en la petición o si toma un valor como <cite>*</cite>, entonces el navegador autoriza el acceso.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Para algunos tipos de peticiones, como las de tipo PUT o DELETE y, en ocasiones, dependiendo de las cabeceras empleadas, también GET o POST, el navegador realiza (no entraremos a analizar los motivos, aunque tienen que ver con no hacer que el servidor modifique su estado ante una petición que no se va a aceptar) una comunicación previa con el servidor (usando el verbo <em>OPTIONS</em>) para realizar algunas comprobaciones <em>pre-vuelo</em> (<em>pre-flight</em>). En esta petición, el navegador añade, además, de <code class="docutils literal notranslate"><span class="pre">Origin</span></code>, la cabecera <code class="docutils literal notranslate"><span class="pre">Access-Control-Request-Method</span></code> con el verbo para el que se desea realizar la petición posterior y <code class="docutils literal notranslate"><span class="pre">Access-Control-Request-Headers</span></code> con las cabeceras que se emplearán en dicha petición. El servidor contesta incluyendo en la respuesta las cabeceras <code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Origin</span></code>, <code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Methods</span></code> (verbos admitidos, en forma de lista de verbos separados por comas) y <code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Headers</span></code> (cabeceras de HTTP admitidas); si los valores permitidos son compatibles con la petición a realizar, esta se lleva finalmente a cabo por parte del navegador.</p>
</div>
<p>Aunque no es fácil engañar al servidor modificando el valor enviado por el navegador en la cabecera <code class="docutils literal notranslate"><span class="pre">Origin</span></code>, debe tenerse en cuenta que el propósito de CORS no es el de hacer un sitio web más seguro; si el servidor devuelve datos privados, es necesario usar <em>cookies</em> o <em>tokens de validación</em>, por ejemplo.</p>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>En una actividad anterior tienes un ejemplo de acceso a un servicio (el de información sobre las películas del estudio Ghibli) que usa CORS. Estúdialo con ayuda de las herramientas para desarrolladores del navegador comprobando las cabeceras. Estudia también una petición vía Fetch a un servidor que no soporte CORS, como el de <a class="reference external" href="https://date.nager.at/Home/Api">esta API</a> de días <a class="reference external" href="http://date.nager.at/api/v1/get/ES/2020">festivos</a>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Importante</p>
<p>Finalmente, es importante resaltar que estas restricciones afectan a los servicios web a los que se intenta acceder desde un navegador. Una aplicación de escritorio o un programa ejecutándose en un servidor no tienen estas restricciones.</p>
</div>
<div class="section" id="peticiones-cors">
<h3><span class="section-number">6.7.1. </span>Peticiones CORS<a class="headerlink" href="#peticiones-cors" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="hazlotu admonition">
<p class="admonition-title">Hazlo tú ahora</p>
<p>La API REST del carrito soporta peticiones Fetch realizadas desde programas en JavaScript descargados de dominios diferentes al dominio en el que está ubicada la API. Para comprobarlo, abre el fichero <code class="docutils literal notranslate"><span class="pre">carrito.html</span></code> desde un servidor web local; recuerda cambiar antes la variable <code class="docutils literal notranslate"><span class="pre">base</span></code> de JavaScript para que apunte al correspondiente <em>endpoint</em> de la API que se está ejecutando en otro puerto u otro servidor (el de Heroku, por ejemplo). Estudia el <em>middleware</em> del código del servidor que gestiona la respuesta.</p>
</div>
<p>Para lanzar el cliente desde un servidor web local, si tienes Python 2 instalado, ejecuta desde el directorio donde está <code class="docutils literal notranslate"><span class="pre">carrito.html</span></code> una de las dos siguientes órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHttpServer</span>
<span class="n">python2</span> <span class="o">-</span><span class="n">m</span> <span class="n">SimpleHttpServer</span>
</pre></div>
</div>
<p>Si tienes Python 3 instalado en tu sistema, ejecuta desde el directorio donde está <code class="docutils literal notranslate"><span class="pre">carrito.html</span></code> una de las dos siguientes órdenes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span>
<span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span>
</pre></div>
</div>
<p>El servidor te informará del puerto en <code class="docutils literal notranslate"><span class="pre">localhost</span></code> desde el que puedes acceder al contenido del directorio. Realiza peticiones desde la aplicación web del carrito y analiza las cabeceras relacionadas con CORS de la petición y la respuesta. Observa cómo las peticiones de tipo GET, POST, PUT o DELETE realizan aquí una comprobación <em>pre-vuelo</em> con el verbo OPTIONS. Modifica el cliente para que envíe una cabecera adicional no convencional como <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> y observa cómo la respuesta del servidor hace que la petición falle al no devolver el servidor el nombre de la cabecera en la lista devuelta en <code class="docutils literal notranslate"><span class="pre">Access-Control-Allow-Headers</span></code>.</p>
</div>
</div>
<div class="section" id="autenticacion-de-usuarios">
<span id="label-signin"></span><h2><span class="section-number">6.8. </span>Autenticación de usuarios<a class="headerlink" href="#autenticacion-de-usuarios" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Una componente importante de la mayoría de aplicaciones web es la que permite que los usuarios se identifiquen o autentiquen en la aplicación y puedan gestionar así sus propios datos. La gestión de cuentas de usuario requiere un esfuerzo adicional (validación de cuentas de correo electrónico, almacenamiento seguro de las contraseñas, gestión de ataques cibernéticos, olvidos de contraseña, etc.) que podemos delegar en servicios de terceros como Facebook Login o Google Sign-in; este último será el que usaremos en esta actividad. De esta forma, el usuario se identifica en una ventana del navegador vinculada a un URL de Google y autoriza a nuestra aplicación a acceder a cierta información de su perfil (nombre y correo electrónico, por ejemplo) sin compartir el resto de sus datos (o permitiendo el acceso a un subconjunto de ellos, como, por ejemplo, los ficheros almacenados en una carpeta de Google Drive).</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Esta actividad solo es necesaria este curso si vas a implementar la parte de la práctica 4 relacionada con la identificación de usuarios. Si no es así, puedes ignorar el resto, salvo que tengas curiosidad en aprender cómo se hace.</p>
</div>
<p>El primer paso para que una aplicación pueda acceder al servicio de identificación de Google Sign-in es obtener las credenciales adecuadas que nos permitan obtener el <em>id del cliente</em>, una secuencia de caracteres que necesitamos para poder usar el servicio desde el código JavaScript del navegador y desde el código en Node.js del servidor. Para ello accede en la consola web de Google Cloud Platform a la opción <span class="guilabel">Credenciales</span> dentro del menú <span class="guilabel">APIs y servicios</span>. Elige crear una credencial de tipo <span class="guilabel">ID de cliente de OAuth</span>. Serás redirigido en primer lugar a la configuración de la pantalla de consentimiento de OAuth: indica como usuarios objetivo a usuarios <em>externos</em> y luego aporta solo los datos obligatorios (nombre de la aplicación y tu dirección de correo electrónico de <code class="docutils literal notranslate"><span class="pre">gcloud.ua.es</span></code>). De vuelto a la pantalla de credenciales, elige de nuevo crear una credencial de tipo <span class="guilabel">ID de cliente de OAuth</span>. En la nueva pantalla, escoge <em>web</em> como tipo de aplicación, introduce un nombre para la aplicación, y en <span class="guilabel">Orígenes de JavaScript autorizados</span> indica los URLs desde los que harás peticiones: normalmente, indicarás un URL del tipo <code class="docutils literal notranslate"><span class="pre">http://localhost:5000</span></code> para cuando la aplicación se lance en local y uno del tipo <code class="docutils literal notranslate"><span class="pre">https://proyecto-10002.appspot.com/</span></code> para cuando se despliegue en un servidor en la nube. No has de indicar nada en la sección <span class="guilabel">URIs de redirección autorizados</span>. Con esta información, ya podrás obtener el <em>id del cliente</em>.</p>
<p>A continuación se describe una aplicación sencilla que permite que el usuario se identifique en el navegador con su cuenta de Google. La aplicación completa está en la carpeta <code class="docutils literal notranslate"><span class="pre">code/gsignin</span></code> del <a class="reference external" href="https://github.com/jaspock/dai2122">repositorio de la asignatura</a> . Tras la autenticación, el código puede obtener una serie de datos del usuario entre los que es especialmente relevante el <em>token id</em>, que será el dato que se enviará al servidor y del que este extraerá un <em>id</em> del usuario que será el que se almacenará en las bases de datos para indicar el usuario asociado a un registro dado. Observa que no se envía al servidor un dato como la dirección de correo electrónico para usarlo como identificador del usuario porque podría cambiar en algún momento del futuro. Tampoco se le envía el <em>id</em> del usuario, sino un <em>token</em> más largo que codifica diferentes datos, incluyendo el <em>id</em> del usuario. Este token deberá ser validado por el servidor antes de dar por bueno el <em>id</em> que incluye.</p>
<p>Este es el código de la parte del cliente:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;!doctype html&gt;</span>
<span class="c">&lt;!-- Ejemplo de uso de la API de autenticación de Google Sign-in --&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;es&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Autenticación de usuarios<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="o">*</span> <span class="p">{</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">visible</span> <span class="p">{</span>
      <span class="k">display</span><span class="p">:</span> <span class="kc">inline</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nc">invisible</span> <span class="p">{</span>
      <span class="k">display</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">info</span> <span class="p">{</span>
      <span class="k">margin-left</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin-top</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">#</span><span class="nn">info</span> <span class="nt">p</span> <span class="p">{</span>
      <span class="k">margin-bottom</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">font-size</span><span class="p">:</span> <span class="mi">90</span><span class="kt">%</span><span class="p">;</span>
      <span class="k">font-family</span><span class="p">:</span> <span class="kc">monospace</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">section</span> <span class="p">{</span>
      <span class="k">margin-top</span><span class="p">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
      <span class="k">margin-bottom</span><span class="p">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">body</span> <span class="p">{</span>
      <span class="k">margin</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Autenticación de usuarios con Google Sign-in<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;f0&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Mensaje:
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;mensaje&quot;</span> <span class="na">required</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>Envía<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">section</span><span class="p">&gt;</span>
    👤 <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;usuario&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;entrar&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;entrar&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;invisible&quot;</span><span class="p">&gt;</span>Identificarse<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;salir&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;invisible&quot;</span><span class="p">&gt;</span>Salir<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;panel&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Información de autenticación:<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;info&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>

  <span class="c">&lt;!-- Librería para usar Google Sign-in --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://apis.google.com/js/platform.js?onload=initGoogleAPI&quot;</span> <span class="na">async</span> <span class="na">defer</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>

  <span class="kr">const</span> <span class="nx">base</span><span class="o">=</span><span class="s2">&quot;/mensajes&quot;</span><span class="p">;</span> <span class="c1">// endpoint</span>
  <span class="kr">const</span> <span class="nx">cabeceras</span><span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Accept&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="c1">// envía una petición al servidor con el texto del mensaje y el token id en la cabecera &#39;Authorization&#39;</span>
  <span class="kd">function</span> <span class="nx">envíaMensaje</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>  <span class="c1">// evita que se recargue la página</span>
    <span class="kr">const</span> <span class="nx">url</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">base</span><span class="si">}</span><span class="sb">/nuevomensaje`</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">payload</span><span class="o">=</span> <span class="p">{</span>
      <span class="nx">texto</span><span class="o">:</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f0 input[name=&#39;mensaje&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="kr">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> 
      <span class="nx">headers</span><span class="o">:</span> <span class="nx">cabeceras</span><span class="p">,</span>
      <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="p">};</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`respuesta del servidor: </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#f0 input[name=&#39;mensaje&#39;]&quot;</span><span class="p">).</span><span class="nx">value</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`problema de conexión: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">loginFirst</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Identifícate antes de usar la aplicación&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// función de inicialización:</span>
  <span class="kd">function</span> <span class="nx">initApp</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#f0&#39;</span><span class="p">);</span>
    <span class="c1">// si no hay token id, el manejador es &#39;loginFirst&#39;; si no, usa &#39;envíaMensaje&#39;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">id_token</span><span class="o">?</span><span class="nx">envíaMensaje</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">:</span><span class="nx">loginFirst</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;#salir&quot;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="nx">signOut</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;DOMContentLoaded&#39;</span><span class="p">,</span><span class="nx">initApp</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>

  <span class="c1">// ---- código que se encarga de la identificación del usuario</span>

  <span class="kd">var</span> <span class="nx">id_token</span><span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// token a enviar al servidor</span>

  <span class="c1">// id de cliente obtenido en la consola web de Google Cloud Platform:</span>
  <span class="kr">const</span> <span class="nx">clientId</span><span class="o">=</span> <span class="s1">&#39;SUSTITUIR POR El CLIENT_ID OBTENIDO EN GOOGLE CLOUD!!!!!!&#39;</span><span class="p">;</span>

  <span class="c1">// muestra el mensaje en la página web junto con la hora:</span>
  <span class="kd">function</span> <span class="nx">printInfo</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">addZero</span><span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="k">while</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">x</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">;</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">addZero</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span><span class="mf">2</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">addZero</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span><span class="mf">2</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">addZero</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">(),</span> <span class="mf">2</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">ms</span> <span class="o">=</span> <span class="nx">addZero</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMilliseconds</span><span class="p">(),</span> <span class="mf">3</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">e</span><span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#info&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">+=</span> <span class="sb">`&lt;p&gt;</span><span class="si">${</span><span class="nx">h</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">m</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">s</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">ms</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">c</span><span class="si">}</span><span class="sb">&lt;/p&gt;`</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// función que se invoca cuando la librería de Google está cargada; el nombre de esta función</span>
  <span class="c1">// se pasa como parámetro al elemento script:</span>
  <span class="kd">function</span> <span class="nx">initGoogleAPI</span><span class="p">()</span> <span class="p">{</span> 
    <span class="c1">// inicializa el objeto GoogleAuth:</span>
    <span class="nx">gapi</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;auth2&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">auth2</span> <span class="o">=</span> <span class="nx">gapi</span><span class="p">.</span><span class="nx">auth2</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
          <span class="nx">client_id</span><span class="o">:</span> <span class="nx">clientId</span><span class="p">,</span>
          <span class="nx">scope</span><span class="o">:</span> <span class="s1">&#39;profile email&#39;</span>
      <span class="p">});</span>

      <span class="kr">const</span> <span class="nx">func</span><span class="o">=</span> <span class="s1">&#39;initGoogleAPI&#39;</span><span class="p">;</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: valor de isSignedIn: </span><span class="si">${</span><span class="nx">auth2</span><span class="p">.</span><span class="nx">isSignedIn</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#usuario&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="c1">// al principio se muestra el botón de identificación y se oculta el de cerrar sesión:</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#salir&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#entrar&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">);</span>

      <span class="c1">// registra el botón que permite iniciar el proceso de autenticación y los funciones</span>
      <span class="c1">// callback correspondientes:</span>
      <span class="nx">auth2</span><span class="p">.</span><span class="nx">attachClickHandler</span><span class="p">(</span><span class="s1">&#39;entrar&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">onSuccessSignIn</span><span class="p">,</span> <span class="nx">onFailureSignIn</span><span class="p">);</span>

      <span class="c1">// registra la función callback que se invoca cuando cambia el estado de logueado/no logueado del usuario:</span>
      <span class="nx">auth2</span><span class="p">.</span><span class="nx">isSignedIn</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">signinChanged</span><span class="p">);</span>

      <span class="c1">// registra la función callback que se llama cada vez que cambia el valor de currentUser:</span>
      <span class="nx">auth2</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">userChanged</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// se ejecuta cuando cambia el estado de login del usuario:</span>
  <span class="kd">var</span> <span class="nx">signinChanged</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">func</span><span class="o">=</span> <span class="s1">&#39;signinChanged&#39;</span><span class="p">;</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: el nuevo estado es </span><span class="si">${</span><span class="nx">val</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: autenticado como </span><span class="si">${</span><span class="nx">auth2</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">getBasicProfile</span><span class="p">().</span><span class="nx">getName</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
      <span class="c1">// token que se enviará al servidor para que lo valide e identifique al usuario:</span>
      <span class="nx">id_token</span><span class="o">=</span> <span class="nx">auth2</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">getAuthResponse</span><span class="p">().</span><span class="nx">id_token</span><span class="p">;</span>
      <span class="c1">// se añade a las cabeceras de las peticiones al servidor el token de autenticación:</span>
      <span class="nx">cabeceras</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span><span class="o">=</span> <span class="sb">`Bearer </span><span class="si">${</span><span class="nx">id_token</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: id token: </span><span class="si">${</span><span class="nx">id_token</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">40</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#usuario&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">auth2</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">getBasicProfile</span><span class="p">().</span><span class="nx">getName</span><span class="p">()</span><span class="si">}</span><span class="sb"> `</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#salir&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#entrar&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">cabeceras</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#usuario&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#salir&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#entrar&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: valor de isSignedIn: </span><span class="si">${</span><span class="nx">auth2</span><span class="p">.</span><span class="nx">isSignedIn</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// esta función se invoca cuando el usuario se loguea tras pulsar el botón; si el usuario estaba identificado</span>
  <span class="c1">// anteriormente y se recarga la página, esta función no se invoca (no se ha pulsado el botón), pero la</span>
  <span class="c1">// librería intenta identificar automáticamente al usuario y, si lo consigue, sí se invoca &#39;signinChanged&#39; y</span>
  <span class="c1">// &#39;userChanged&#39;:</span>
  <span class="kd">function</span> <span class="nx">onSuccessSignIn</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">func</span><span class="o">=</span> <span class="s1">&#39;onSuccessSignIn&#39;</span><span class="p">;</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: autenticado como </span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">getBasicProfile</span><span class="p">().</span><span class="nx">getName</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="c1">// otra forma de obtener el mismo valor:</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: autenticado como </span><span class="si">${</span><span class="nx">auth2</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">.</span><span class="nx">get</span><span class="p">().</span><span class="nx">getBasicProfile</span><span class="p">().</span><span class="nx">getName</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">profile</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">getBasicProfile</span><span class="p">();</span>
    <span class="c1">// no enviar getId al servidor, sino el id token que puede ser validado en el servidor:</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: id: </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">getId</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span> 
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: name: </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">getName</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: image URL: </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">getImageUrl</span><span class="p">().</span><span class="nx">substr</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">40</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="p">);</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: email: </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">getEmail</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span> <span class="c1">// nulo si no usamos el scope &#39;email&#39;</span>
    
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: id token: </span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">getAuthResponse</span><span class="p">().</span><span class="nx">id_token</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">40</span><span class="p">)</span><span class="si">}</span><span class="sb">...`</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// función de callback cuando el usuario no puede loguearse:</span>
  <span class="kd">function</span> <span class="nx">onFailureSignIn</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">id_token</span><span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">func</span><span class="o">=</span> <span class="s1">&#39;onFailureSignIn&#39;</span><span class="p">;</span>
    <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// manejador del evento de hacer clic en el botón de salir de la sesion:</span>
  <span class="kd">function</span> <span class="nx">signOut</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">auth2</span><span class="p">.</span><span class="nx">signOut</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">func</span><span class="o">=</span> <span class="s1">&#39;signOut&#39;</span><span class="p">;</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: el usuario salió`</span><span class="p">);</span>
      <span class="nx">id_token</span><span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">cabeceras</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>        

  <span class="c1">// función de callback invocada cuando cambia el usuario logueado:</span>
  <span class="kd">function</span> <span class="nx">userChanged</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">getId</span><span class="p">()){</span>
      <span class="kr">const</span> <span class="nx">func</span><span class="o">=</span> <span class="s1">&#39;userChanged&#39;</span><span class="p">;</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: id: </span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">getId</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">profile</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">getBasicProfile</span><span class="p">();</span>
      <span class="nx">printInfo</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">func</span><span class="si">}</span><span class="sb">: name: </span><span class="si">${</span><span class="nx">profile</span><span class="p">.</span><span class="nx">getName</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>El código del lado del navegador es el que lleva el mayor peso de la tarea. Como puedes ver, la librería de Google <code class="docutils literal notranslate"><span class="pre">apis.google.com/js/platform.js</span></code> simplifica gran parte del proceso. La función <code class="docutils literal notranslate"><span class="pre">initGoogleAPI</span></code> inicializa el objeto <code class="docutils literal notranslate"><span class="pre">auth2</span></code> y registra diferentes funciones de <em>callback</em> que serán invocadas cuando el usuario se logre autenticar pulsando el botón (<code class="docutils literal notranslate"><span class="pre">onSuccessSignIn</span></code>), cuando el paso anterior falle (<code class="docutils literal notranslate"><span class="pre">onFailureSignIn</span></code>) o cuando el usuario se identifique por cualquier medio (<code class="docutils literal notranslate"><span class="pre">signinChanged</span></code>). Observa que es posible que se invoque <code class="docutils literal notranslate"><span class="pre">signinChanged</span></code> sin invocar <code class="docutils literal notranslate"><span class="pre">onSuccessSignIn</span></code>; por ejemplo, si un usuario se ha identificado previamente, no ha salido de la aplicación, pero cierra la página y vuelve a abrirla, entonces la librería autentica automáticamente al usuario y llama a <code class="docutils literal notranslate"><span class="pre">signinChanged</span></code> pero no a <code class="docutils literal notranslate"><span class="pre">onSuccessSignIn</span></code>. Se incluye también una función (<code class="docutils literal notranslate"><span class="pre">signOut</span></code>) para salir de la aplicación cuando se pulsa el botón correspondiente; en este caso, también se llamará a <code class="docutils literal notranslate"><span class="pre">signinChanged</span></code> con el valor <code class="docutils literal notranslate"><span class="pre">false</span></code> como parámetro.</p>
<p>El <em>token id</em> se obtiene con <code class="docutils literal notranslate"><span class="pre">auth2.currentUser.get().getAuthResponse().id_token</span></code> y se envía al servidor en la cabecera de HTTP <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> con el prefijo estándar <code class="docutils literal notranslate"><span class="pre">Bearer</span></code> que identifica el tipo de autenticación.</p>
<p>En el lado del servidor, hay pocas novedades reseñables:</p>
<div class="highlight-javascript notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">CLIENT_ID</span><span class="o">=</span> <span class="s1">&#39;SUSTITUIR POR El CLIENT_ID OBTENIDO EN GOOGLE CLOUD!!!!!!&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="p">{</span><span class="nx">OAuth2Client</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;google-auth-library&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">oauth2Client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OAuth2Client</span><span class="p">(</span><span class="nx">CLIENT_ID</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">user</span><span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">base</span><span class="o">=</span> <span class="s1">&#39;/mensajes&#39;</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">ticket</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">oauth2Client</span><span class="p">.</span><span class="nx">verifyIdToken</span><span class="p">({</span>
      <span class="nx">idToken</span><span class="o">:</span> <span class="nx">token</span><span class="p">,</span>
      <span class="nx">audience</span><span class="o">:</span> <span class="nx">CLIENT_ID</span><span class="p">,</span> 
  <span class="p">});</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Ticket: &quot;</span><span class="o">+</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ticket</span><span class="p">));</span>
  <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">ticket</span><span class="p">.</span><span class="nx">getPayload</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">payload</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// middleware que comprueba que el usuario está autenticado, antes de pasar el contro a la siguiente función:</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;authorization&#39;</span><span class="p">];</span> <span class="c1">// &#39;authorization&#39; porque Express convierte las cabeceras a minúsculas</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Cabecera Authorization: </span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">40</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;falta la cabecera authorization&#39;</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">7</span><span class="p">,</span><span class="nx">token</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;cabecera authorization mal formada&#39;</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// valida el token enviado por el cliente:</span>
    <span class="kd">let</span> <span class="nx">payload</span><span class="o">=</span> <span class="nx">await</span> <span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="c1">// extrae del token el id del usuario:</span>
    <span class="nx">user</span><span class="o">=</span> <span class="nx">payload</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">];</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Id asignado al usuario </span><span class="si">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb"> por el middleware: </span><span class="si">${</span><span class="nx">payload</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="sb">`error en la cabecera authorization: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">base</span><span class="o">+</span><span class="s1">&#39;/nuevomensaje&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">404</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="s1">&#39;usuario no autenticado&#39;</span> <span class="p">});</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// se omite, pero aquí se realizaría cualquier procesamiento del texto del mensaje ligado al usuario</span>
  <span class="c1">// identificado (como, por ejemplo, insertarlo en una base de datos vinculada al usuario):</span>
  <span class="c1">// ...</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Procesando mensaje &#39;</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">texto</span><span class="si">}</span><span class="sb">&#39; para el usuario </span><span class="si">${</span><span class="nx">user</span><span class="si">}</span><span class="sb">...`</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">result</span><span class="o">:</span><span class="sb">`procesando mensaje &#39;</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">texto</span><span class="si">}</span><span class="sb">&#39; para el usuario </span><span class="si">${</span><span class="nx">user</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="kc">null</span> <span class="p">});</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">publico</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">);</span>
<span class="c1">// __dirname: carpeta del proyecto</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">publico</span><span class="p">));</span>

<span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mf">5000</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Aplicación lanzada en el puerto </span><span class="si">${</span> <span class="nx">PORT</span> <span class="si">}</span><span class="sb">!`</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div>
<p>Se ha añadido un <em>middleware</em> que obtiene el valor de la cabecera <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> y lo verifica usando la función <code class="docutils literal notranslate"><span class="pre">verifyIdToken</span></code> del módulo de Node.js <code class="docutils literal notranslate"><span class="pre">google-auth-library</span></code>. Del objeto devuelto se puede extraer el <em>id</em> del usuario con <code class="docutils literal notranslate"><span class="pre">getPayload()['sub']</span></code> y usar este valor como identificador del usuario en la base de datos (esta parte se ha omitido en el código, ya que ya se estudió en un apartado anterior).</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Si necesitas aclarar algún aspecto del código anterior, puedes consultar la referencia del <a class="reference external" href="https://developers.google.com/identity/sign-in/web/reference">cliente de JavaScript de Google Sign-in</a>, la guía <a class="reference external" href="https://developers.google.com/identity/sign-in/web/sign-in">Integrating Google Sign-in into your web app</a>, la <a class="reference external" href="https://github.com/google/google-api-javascript-client">documentación de la librería de Google</a> o la descripción del <a class="reference external" href="https://developers.google.com/identity/protocols/OAuth2">acceso con OAuth 2.0 a la API de Google</a>.</p>
<blockquote>
<div></div></blockquote>
</div>
<p>Con lo anterior, la autenticación se realiza almacenando los datos del usuario en un <em>token</em> que genera una vez el servidor y que el cliente envía como cabecera en cada petición posterior, lo que constituye un ejemplo de <a class="reference external" href="https://dev.to/thecodearcher/what-really-is-the-difference-between-session-and-token-based-authentication-2o39">autenticación sin sesión</a> (<em>session-less</em>). El <em>token</em> suele codificar la información siguiendo el estándar JWT (por <em>JSON web token</em>) y es validado por el servidor para cada petición. La comunicación entre el cliente y el servidor se ha de realizar encriptada mediante protocolos seguros como SSL/HTTPS para que terceros no puedan obtener el <em>token</em> y suplantar la identidad del usuario. Los enfoques de autenticación basados en sesión, por otro lado, almacenarían los datos del usuario en la memoria del servidor (lo que pude plantear problemas si la cantidad de usuarios es muy grande) y enviarían una <em>cookie</em> con el identificador de sesión al cliente, que a su vez la adjuntaría a cada petición.</p>
<blockquote>
<div></div></blockquote>
</div>
<div class="section" id="terminos-de-uso-de-las-apis-web">
<h2><span class="section-number">6.9. </span>Términos de uso de las APIs web<a class="headerlink" href="#terminos-de-uso-de-las-apis-web" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Aunque no lo estudiaremos en esta asignatura, hay que tener en cuenta que existen en la web multitud de APIs disponibles para su uso desde aplicaciones de terceros, pero estas APIs suelen tener términos de uso (mira las condiciones de la <a class="reference external" href="https://developer.twitter.com/en/developer-terms/agreement-and-policy">API de Twitter</a>, por ejemplo) que es importante leer antes de decidirse a basar una determinada aplicación en ellas.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="nube.html" class="btn btn-neutral float-right" title="7. Computación en la nube" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="componentes.html" class="btn btn-neutral float-left" title="5. Componentes web" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Juan Antonio Pérez

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>